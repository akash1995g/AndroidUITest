name: Android Build Workflow V1

on:
  workflow_dispatch:
    inputs:
      runner_type:
        description: 'üñ•Ô∏è Runner ‚Üí Select runner type'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - self-hosted
      ui_test:
        description: 'üì± UI Test ‚Üí Select UI test runner'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - self
          - lib
      release:
        description: 'üöÄ Release ‚Üí Select release type'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - production
          - beta
          - alpha
          - internal
      skip_sonar:
        description: 'üîç Sonar ‚Üí Skip SonarQube analysis'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      device-ip:
        type: string
        description: 'üì° Device ‚Üí Android device IP'

      # Create labels for repo
      create_labels:
        description: 'üè∑Ô∏è Labels ‚Üí Create labels'
        type: boolean
        default: false

      delete_labels:
        description: 'üè∑Ô∏è Labels ‚Üí Delete labels'
        type: boolean
        default: false

  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled
    branches:
      - main
      - dev
      - feature/update
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  select-runner:
    if: ${{ (github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'Stop')) || github.event_name == 'workflow_dispatch' }}
    #uses: ./.github/workflows/selfwithstage.yml
    uses: akash1995g/workflow/.github/workflows/selfwithstage.yml@main
    with:
      runner: ${{
        github.event_name == 'workflow_dispatch' && inputs.runner_type ||
        (github.event_name == 'pull_request' || github.event_name == 'push') &&
        (contains(github.event.pull_request.labels.*.name, 'Ubuntu-latest') && 'ubuntu-latest' || 'self-hosted')
        }}
      ui_test: ${{ inputs.ui_test || 'none' }}
      release_type: ${{ inputs.release || 'none' }}
      skip_sonar: ${{
        (github.event_name == 'workflow_dispatch' && inputs.skip_sonar == 'true') ||
        (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'Skip-Sonar'))
        }}
      package_name: com.androidapp.anywifirouter
      device-ip: ${{  inputs.device-ip  }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
#      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
#      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
#      PLAY_STORE_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
      MY_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN  }}

  labels:
    uses: akash1995g/workflow/.github/workflows/create-multiple-labels.yml@main
    with:
      runner: ${{
        github.event_name == 'workflow_dispatch' && inputs.runner_type ||
        (github.event_name == 'pull_request' || github.event_name == 'push') &&
        (contains(github.event.pull_request.labels.*.name, 'Ubuntu-latest') && 'ubuntu-latest' || 'self-hosted')
        }}
      create_labels: ${{ inputs.create_labels }}
      delete_labels: ${{ inputs.delete_labels }}
